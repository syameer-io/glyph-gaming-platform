# Glyph Supervisor Configuration
# ================================
# Manages background processes for Laravel Reverb and Queue Workers
#
# INSTALLATION:
# 1. Copy to server: /etc/supervisor/conf.d/glyph.conf
# 2. Reload: supervisorctl reread
# 3. Update: supervisorctl update
# 4. Start: supervisorctl start glyph:*
# 5. Verify: supervisorctl status

# =============================================================================
# LARAVEL REVERB - WebSocket Server
# =============================================================================
# Handles real-time WebSocket connections for:
# - Live chat messaging
# - Voice channel presence
# - Typing indicators
# - Real-time notifications

[program:glyph-reverb]
command=php /var/www/glyph/artisan reverb:start --host=0.0.0.0 --port=8080
directory=/var/www/glyph
user=www-data
autorestart=true
autostart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/reverb.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stopwaitsecs=3600
stopsignal=SIGTERM

# =============================================================================
# QUEUE WORKERS - Background Job Processing
# =============================================================================
# Processes background jobs such as:
# - Sending emails (OTP, notifications)
# - Steam API data fetching
# - Broadcasting events
# - Scheduled cleanup tasks

[program:glyph-queue]
command=php /var/www/glyph/artisan queue:work --sleep=3 --tries=3 --timeout=60 --max-jobs=1000 --max-time=3600
directory=/var/www/glyph
user=www-data
numprocs=2
process_name=%(program_name)s_%(process_num)02d
autorestart=true
autostart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/queue.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stopasgroup=true
killasgroup=true

# =============================================================================
# PROCESS GROUP
# =============================================================================
# Groups all Glyph processes together for easier management
# Commands:
#   supervisorctl start glyph:*    - Start all processes
#   supervisorctl stop glyph:*     - Stop all processes
#   supervisorctl restart glyph:*  - Restart all processes
#   supervisorctl status           - View status

[group:glyph]
programs=glyph-reverb,glyph-queue
priority=999

# =============================================================================
# NOTES
# =============================================================================
#
# After deploying new code, restart the processes:
#   supervisorctl restart glyph:*
#
# After changing queue jobs or events:
#   php artisan queue:restart
#   supervisorctl restart glyph:glyph-queue_00 glyph:glyph-queue_01
#
# View logs:
#   supervisorctl tail -f glyph:glyph-reverb
#   supervisorctl tail -f glyph:glyph-queue_00
#
# Or directly:
#   tail -f /var/log/supervisor/reverb.log
#   tail -f /var/log/supervisor/queue.log
